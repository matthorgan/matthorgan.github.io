[
    {
        "ref": "https://matthorgan.xyz/blog/hugo-and-appveyor-goodness/",
        "title": "Hugo \u0026 AppVeyor (Continuous Integration Blog Goodness)",
        "section": "blog",
        "tags": ["go","golang","hugo","development","powershell","winops","continuous integration","appveyor"],
        "date" : "2017.03.16",
        "body": "Recently, I\u0026rsquo;ve been thinking about how I can use DevOps tools and processes to improve the way I do things and this has led me to completely revamp my blog. My existing Wordpress blog has now been replaced with a shiny new blog using Hugo - a static website engine, hosted on Github Pages and automated using the continuous integration tool AppVeyor. In this article, I\u0026rsquo;m going to go through a step-by-step guide on how I set everything up.\nStep 1. Install Hugo \u0026amp; Build New Site First off, it\u0026rsquo;s worth mentioning that this step-by-step guide assumes you\u0026rsquo;re running a Windows environment and using the Windows package manager Chocolatey (If you don\u0026rsquo;t know about Chocolatey then you NEED to get this in your life right now. Check it out here).\nI won\u0026rsquo;t go into too much detail about Hugo because there\u0026rsquo;s some great stuff online already but essentially, Hugo renders all of your static content into HTML, CSS and JavaScript. This makes pages on the site really quick to load and easy to manage as you don\u0026rsquo;t rely on a traditional CMS to manage content. Install Hugo by running:\nchoco install hugo -y Next up, creating a new skeleton site structure is as simple as running:\nhugo new site mynewblog If you have a look in your newly created site folder, it\u0026rsquo;ll look something like this:\nNow that we have the basic layout, we need to add a theme. I ended up browsing the theme section on Hugo\u0026rsquo;s website to find one I liked. Once you\u0026rsquo;ve found a theme that you like, clone it into the themes folder of your newly created site.\nOn my local machine, I use posh-git which integrates Git nicely into PowerShell (Including tab completion). To install posh-git, simply run the following from PowerShell:\nchoco install poshgit -y Note: You may need to reload your PowerShell session to use the Git commands from PowerShell. With Git installed, clone the theme you like:\ncd themes git clone https://github.com/example/example-theme Usually, a theme will have an \u0026rsquo;exampleSite\u0026rsquo; directory which contains an example structure for the theme including an example config.toml configuration file:\nI copied these files over into the root of my new Hugo site and started tailoring to fit my needs. I won\u0026rsquo;t go into any further detail on that part - just play around with it and follow your nose. So, you\u0026rsquo;ve got a theme you\u0026rsquo;re happy with and you\u0026rsquo;ve tweaked the configuration to your liking? Hugo has a very convenient web server that listens on port 1313 so that you can view how your glorious website will look when built. To make use of this, run the command:\nhugo server The great thing about this is, every time you update any of your static files, the changes will instantly appear at http://localhost:1313 Right, now we\u0026rsquo;ve got our new Hugo site configured the way we want it, let\u0026rsquo;s set up our Github pages.\nStep 2. Setting up Github Pages to work with our new Hugo site If you haven\u0026rsquo;t already got a Github account, head over to GitHub and sign up for one. Once you\u0026rsquo;ve got your account set up, create a new repository and call it yourusername.github.io e.g. mine is matthorgan.github.io.\nFor this build, we\u0026rsquo;re going to be using two branches - \u0026lsquo;source\u0026rsquo; which will house all of the static content and \u0026lsquo;master\u0026rsquo; which will house the Hugo built content. Doing it this way allows us to have both the static and generated content completely version controlled. From PowerShell, browse to the root directory of your Hugo site and run the following commands to set up your local repository and push it to your Github repo:\ngit init git add --all git commit -m \u0026#34;Initial Hugo static file commit\u0026#34; git remote add origin https://github.com/yourusername/yourusername.github.io.git git push -u origin source Note: Replace \u0026lsquo;yourusername\u0026rsquo; with your actual Github username and repo name We\u0026rsquo;ve now got our static content pushed to a branch in our Github Pages repo called \u0026lsquo;source\u0026rsquo;. At this point, you can move on to the continuous integration with AppVeyor however just for completeness, I\u0026rsquo;ll continue to explain how you get your page online without a CI tool.\nType the following command from a PowerShell prompt in the root directory of your Hugo site to build the site:\nhugo If you have a look in the root directory, you\u0026rsquo;ll now see a \u0026lsquo;public\u0026rsquo; folder which has all of your built content e.g. HTML, JavaScript, CSS etc.\nChange directory into the public folder and type the following:\ngit checkout -b master git add --all git commit -m \u0026#34;Initial Hugo built site commit\u0026#34; git push -u origin master You should now have your website online and browsable at https://yourusername.github.io - take a moment to bask in its unfinished glory before we move on to the cool stuff!\nStep 3. Using AppVeyor to automate the Hugo build Having our newly generated website up and running already is cool but each time you add/modify any of the static content, the site will need to be rebuilt and pushed up to GitHub. That\u0026rsquo;s at least two buttons more than I want to have to press so we\u0026rsquo;re going to use AppVeyor to automate it for us. Head over to AppVeyor and sign up with GitHub if you haven\u0026rsquo;t already got an account. Once you\u0026rsquo;re logged in, you should be able to add your GitHub pages repo as a new project by clicking Projects \u0026ndash;\u0026gt; New Project and selecting your GitHub repo.\nAt this point, we have two options on how we want to configure the project. You can edit the settings of your project and configure everything within the AppVeyor UI or you can create an appveyor.yml file with the relevant settings and place it in the root of your GitHub repo. Here\u0026rsquo;s what you\u0026rsquo;ll see in the AppVeyor UI: You can see from the menu in the above screenshot that there are so many possibilities when it comes to the configuration of your project. A cool feature of the UI is that you can export to an appveyor.yml file which makes it really easy to understand what\u0026rsquo;s going on. Another great way to understand all of the possible settings within an appveyor.yml file is to check out this reference guide here.\nNote: The UI and appveyor.yml are mutually exclusive so you\u0026rsquo;ll have to pick one or the other.\nWith so many options available, it\u0026rsquo;s important to understand exactly what you want your build to accomplish. To stop me from going off on a tangent, I put together a basic flow for what I needed AppVeyor to do:\nClone the \u0026lsquo;source\u0026rsquo; branch into the AppVeyor build Set up environment by installing Hugo Build site with Hugo Clone \u0026lsquo;master\u0026rsquo; branch of GitHub Pages repo Copy all newly generated content into the newly cloned \u0026lsquo;master\u0026rsquo; directory Add and commit new files to \u0026lsquo;master\u0026rsquo; branch Push new commits back up to master If you have a look back at the screenshot of the AppVeyor settings, you can see an option to specify a default branch. I made sure to set this to my \u0026lsquo;source\u0026rsquo; branch which ensures AppVeyor clones the \u0026lsquo;source\u0026rsquo; branch into the AppVeyor build.\nBelow is the final appveyor.yml file that I ended up with (I\u0026rsquo;ll explain it in more detail shortly). I pushed this to my \u0026lsquo;source\u0026rsquo; branch which instructs AppVeyor to execute the build every time something new is pushed to the source branch e.g. a new blog post.\nversion: 1.0.{build} pull_requests: do_not_increment_build_number: true environment: source_dir: public git_name: Matt Horgan git_email: matt@matthorgan.xyz target_dir: temp target_branch: master repo: https://github.com/matthorgan/matthorgan.github.io.git access_token: secure: RcRrztcM59Im5xl40yelyNPtMZ8ydkEtFQ8nzen+4tcId4U8eT8yrTxTDOyUnJZu install: - cmd: cinst hugo build_script: - cmd: hugo # Add newly built site to the master branch on_success: - ps: Invoke-Expression \u0026#34;git config --global credential.helper store\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Add-Content \u0026#34;$env:userprofile\\.git-credentials\u0026#34; \u0026#34;https://$($env:access_token):x-oauth-basic@github.com`n\u0026#34; - ps: $revision = Invoke-Expression \u0026#34;git rev-parse HEAD\u0026#34; 2\u0026gt;\u0026amp;1 - ps: New-Item -Path $env:target_dir -ItemType Directory - ps: cd .\\$env:target_dir - ps: Invoke-Expression \u0026#34;git clone --branch $env:target_branch $env:repo (Get-Location).Path\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Copy-Item -Path ..\\$env:source_dir\\* -Destination . -Recurse -Force -Exclude @(\u0026#34;.git\u0026#34;,\u0026#34;appveyor.yml\u0026#34;) - ps: Invoke-Expression \u0026#34;git config --global user.name $env:git_name\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git config --global user.email $env:git_email\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git add --all\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git commit --allow-empty -m \u0026#39;Built from commit $revision\u0026#39;\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git push origin $env:target_branch\u0026#34; 2\u0026gt;\u0026amp;1 Some of the settings are self-explanatory but I\u0026rsquo;ll go through the different sections and explain what\u0026rsquo;s going on:\nenvironment: source_dir: public git_name: Matt Horgan git_email: matt@matthorgan.xyz target_dir: temp target_branch: master repo: https://github.com/matthorgan/matthorgan.github.io.git access_token: secure: RcRrztcM59Im5xl40yelyNPtMZ8ydkEtFQ8nzen+4tcId4U8eT8yrTxTDOyUnJZu In the above section, we set up our environment variables which get used further down in the appveyor.yml file. The crucial part of this section is the secure access token which must be created to give AppVeyor permissions to push to your repo. For a great guide on how to set this up, check out this article on the AppVeyor site.\nThe next interesting section of the AppVeyor YAML file is as shown:\ninstall: - cmd: cinst hugo build_script: - cmd: hugo The \u0026lsquo;cinst hugo\u0026rsquo; command tells AppVeyor to install Hugo using Chocolatey whilst the next line builds the site.\nFinally, the PowerShell section of the file:\non_success: - ps: Invoke-Expression \u0026#34;git config --global credential.helper store\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Add-Content \u0026#34;$env:userprofile\\.git-credentials\u0026#34; \u0026#34;https://$($env:access_token):x-oauth-basic@github.com`n\u0026#34; - ps: $revision = Invoke-Expression \u0026#34;git rev-parse HEAD\u0026#34; 2\u0026gt;\u0026amp;1 - ps: New-Item -Path $env:target_dir -ItemType Directory - ps: cd .\\$env:target_dir - ps: Invoke-Expression \u0026#34;git clone --branch $env:target_branch $env:repo (Get-Location).Path\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Copy-Item -Path ..\\$env:source_dir\\* -Destination . -Recurse -Force -Exclude @(\u0026#34;.git\u0026#34;,\u0026#34;appveyor.yml\u0026#34;) - ps: Invoke-Expression \u0026#34;git config --global user.name $env:git_name\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git config --global user.email $env:git_email\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git add --all\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git commit --allow-empty -m \u0026#39;Built from commit $revision\u0026#39;\u0026#34; 2\u0026gt;\u0026amp;1 - ps: Invoke-Expression \u0026#34;git push origin $env:target_branch\u0026#34; 2\u0026gt;\u0026amp;1 On the first two PowerShell lines, we set up our Git credentials to ensure we aren\u0026rsquo;t prompted for a password utilising our access_token variable we created earlier. We then grab the Git revision number and store it in a variable before creating a new directory and changing into it. Next up, we clone the master branch from our Github repo into the folder we\u0026rsquo;ve just changed into before recursively copying the \u0026lsquo;public\u0026rsquo; built site into the directory (excluding .git and appveyor.yml files).\nWe now have all of the latest built files copied into the freshly cloned master repo folder. The last thing for us to do is to add our username and email to our Git config, stage the files and commit with reference to the revision number and push it to our master branch.\nNote: You might be wondering why all of the Git commands are ran using the Invoke-Expression command and redirect standard error to standard output (2\u0026gt;\u0026amp;1). Without this, it seems that the Appveyor shell treats some of the output from Git as standard error which produces horrible red text and obviously stops the build. By utilising the redirect and Invoke-Expression, the build successfully runs without error.\nThat's all for now folks... I might come back and add a small section on setting up a custom domain at a later date. "
    }
]
