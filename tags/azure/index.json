[
    {
        "ref": "https://matthorgan.xyz/blog/powershell-unexpected-character-error/",
        "title": "PowerShell Unexpected Character Error",
        "section": "blog",
        "tags": ["powershell","automation","azure","ci/cd","devops"],
        "date" : "2023.01.05",
        "body": "Over the years, I\u0026rsquo;ve had a few different Unexpected character encountered errors in PowerShell and for the longest time, they were always a real pain to troubleshoot and looked like a bug. Once you know the issue though, it\u0026rsquo;s a fairly simple one to solve. The latest one I\u0026rsquo;ve come across is running the following command from our CI/CD Linux build container to a Windows 2012 machine hosted in Azure:\nInvoke-AzVMRunCommand -ResourceGroupName $VMResourceGroupName -Name $VMName -CommandId 'RunPowerShellScript' -ScriptPath \u0026quot;tests/gather-vm-info.ps1\u0026quot;\nThe above command is using the Azure VM run command to run the contents of tests/gather-vm-info.ps1 on the remote Windows 2012 VM. It should be noted, I was running the exact same command on Windows 2016, and Windows 2019 VMs without any issues. The error I was seeing was the following:\nJsonReaderException: Unexpected character encountered while parsing value: W. Path \u0026#39;\u0026#39;, line 0, position 0. ArgumentException: Conversion from JSON failed with error: Unexpected character encountered while parsing value: W. Path \u0026#39;\u0026#39;, line 0, position 0. at \u0026lt;ScriptBlock\u0026gt;, /builds/golden-images/tests/gather-vm-info.ps1:49 Initially looking at this error, it felt \u0026lsquo;buggy\u0026rsquo; considering there was no \u0026lsquo;W\u0026rsquo; in my output when I ran the tests/gather-vm-info.ps1 code individually on the VM itself. I assumed it must be an issue with the Invoke-AzVMRunCommand but actually, when you look closer at the output, it\u0026rsquo;s easy to see what the issue is.\nValue[0] : Code : ComponentStatus/StdOut/succeeded Level : Info DisplayStatus : Provisioning succeeded Message : WARNING: Ping to \u0026lt;redacted URL\u0026gt; failed -- Status: TimedOut { \u0026#34;Output1\u0026#34;: true, \u0026#34;Output2\u0026#34;: true, \u0026#34;Output3\u0026#34;: true, \u0026#34;Output4\u0026#34;: true, \u0026#34;Output5\u0026#34;: false, \u0026#34;Output6\u0026#34;: true, \u0026#34;Output7\u0026#34;: true, \u0026#34;Output8\u0026#34;: false, \u0026#34;Output9\u0026#34;: false } As you can see, on investigating the Value.Message property of the object returned from Invoke-AzVMRunCommand, we\u0026rsquo;ve got a warning message at the very start of the output before our custom JSON. Suddenly, the W character in the initial error makes sense. In our scenario, Value.Message returns all output including any warning messages and therefore whilst our JSON is being returned correctly, we need to ensure that any warning messages are properly handled or suppressed to ensure that our output only returns JSON ready to be converted.\nSo, the next time you see a weird unexpected parsing error, have a look at what the starting character is. If it\u0026rsquo;s a W, there\u0026rsquo;s a good chance you could be trying to parse something that has captured one of the PowerShell output streams along with your expected output.\n"
    }
]
