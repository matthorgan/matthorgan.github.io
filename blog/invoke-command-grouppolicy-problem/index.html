<!DOCTYPE html>
<html>
  <head>
  <title>
      
          Invoke-Command Group Policy Gotcha (Whoops!) - Matt&#39;s Blog
      
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Matt Horgan" />
  <link rel="shortcut icon" type="image/x-icon" href="https://matthorgan.xyz/img/favicon.ico">

  
  
  
  
  
  <link rel="stylesheet" href="https://matthorgan.xyz/style.min.39acacc5d2051426f655a6b7fbf4786fbd0fd8fffd09322c9b497ef0f7439b3f.css" integrity="sha256-OaysxdIFFCb2Vaa3&#43;/R4b70P2P/9CTIsm0l&#43;8PdDmz8=">
  
  
  
  <link rel="stylesheet" href="https://matthorgan.xyz/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css" media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB&#43;BLd7VPoFFdCmg9OezbJR26lg/h&#43;Wb3/zb8I=">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  
  

  <meta property="og:title" content="Invoke-Command Group Policy Gotcha (Whoops!)" />
<meta property="og:description" content="A task that I&rsquo;ve been working on recently is the automation of VM builds and post configuration using PowerShell and the PowerCLI module (Unfortunately we don&rsquo;t have a configuration management tool to make our lives easier at the moment).
Part of the post-build configuration is to run a bunch of commands on the newly built VMs. I could have used PowerCLI&rsquo;s Invoke-VMScript command to achieve this however as all of the VMs were joining the domain and tools on some of the VM templates were out of date, I used PowerShell&rsquo;s Invoke-Command." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://matthorgan.xyz/blog/invoke-command-grouppolicy-problem/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2017-07-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-07-09T00:00:00+00:00" />
<meta itemprop="name" content="Invoke-Command Group Policy Gotcha (Whoops!)">
<meta itemprop="description" content="A task that I&rsquo;ve been working on recently is the automation of VM builds and post configuration using PowerShell and the PowerCLI module (Unfortunately we don&rsquo;t have a configuration management tool to make our lives easier at the moment).
Part of the post-build configuration is to run a bunch of commands on the newly built VMs. I could have used PowerCLI&rsquo;s Invoke-VMScript command to achieve this however as all of the VMs were joining the domain and tools on some of the VM templates were out of date, I used PowerShell&rsquo;s Invoke-Command."><meta itemprop="datePublished" content="2017-07-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2017-07-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="361">
<meta itemprop="keywords" content="powershell,automation,invoke-command,gpupdate /force," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:image" content="https://matthorgan.xyz/img/avatar.jpg"/>
<meta name="twitter:title" content="Invoke-Command Group Policy Gotcha (Whoops!)"/>
<meta name="twitter:description" content="A task that I&rsquo;ve been working on recently is the automation of VM builds and post configuration using PowerShell and the PowerCLI module (Unfortunately we don&rsquo;t have a configuration management tool to make our lives easier at the moment).
Part of the post-build configuration is to run a bunch of commands on the newly built VMs. I could have used PowerCLI&rsquo;s Invoke-VMScript command to achieve this however as all of the VMs were joining the domain and tools on some of the VM templates were out of date, I used PowerShell&rsquo;s Invoke-Command."/>

  <!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <![endif]-->

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112770718-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
</head>

  <body>
    
  <h1>Invoke-Command Group Policy Gotcha (Whoops!)</h1>
  <header>
  
  <div class="avatar">
    <img class="avatarMask" src="https://matthorgan.xyz/img/avatar.jpg" alt="">
    <a href="https://matthorgan.xyz"><img class="avatar-border" src="https://matthorgan.xyz/img/avatar-border.svg" alt=""></a>
  </div>
  
  <h2><a class="author" href="https://matthorgan.xyz">Matt Horgan</a></h2>
</header>

  
  
  
  <p class="date">July 9, 2017</p>
  
  
  
  <div id="tags">
    <ul>
      
        
        
          <li><a href="https://matthorgan.xyz/tags/powershell/">powershell</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/automation/">automation</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/invoke-command/">invoke-command</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/gpupdate-/force/">gpupdate /force</a></li>
        
      
    </ul>
  </div>
  
  
  <div id="contentBody">
    <p>A task that I&rsquo;ve been working on recently is the automation of VM builds and post configuration using PowerShell and the PowerCLI module (Unfortunately we don&rsquo;t have a configuration management tool to make our lives easier at the moment).</p>
<p>Part of the post-build configuration is to run a bunch of commands on the newly built VMs. I could have used PowerCLI&rsquo;s Invoke-VMScript command to achieve this however as all of the VMs were joining the domain and tools on some of the VM templates were out of date, I used PowerShell&rsquo;s Invoke-Command. This was going swimmingly until I ran into an issue&hellip;</p>
<p>The final requirement of the initial post configuration was to force refresh Group Policy on the machine. Easy right?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Command -ComputerName $VmName -ScriptBlock {gpupdate /force}
</span></span></code></pre></div><p>Upon running this command, I was faced with absolutely nothing being returned - the prompt was just hanging. Eh?! So, what happens if I just run a gpupdate without the force switch?</p>
<p><img src="https://matthorgan.xyz/img/gpupdate-works.PNG" alt=""></p>
<p>Right, so that works perfectly. Hmm, maybe the sheer number of policies that need to apply is slowing things down? What happens if we try a VM that already has the right policies?</p>
<p><img src="https://matthorgan.xyz/img/gpupdate-works.PNG" alt=""></p>
<p>OK, so this seems to imply that the issue is purely with the initial application of the policies. The next step is to RDP onto the VM and try the command locally to see what gets returned:</p>
<p><img src="https://matthorgan.xyz/img/gpupdate-requires-reboot.PNG" alt=""></p>
<p>Bingo! The Group Policy update was working fine but required a reboot. Of course Invoke-Command isn&rsquo;t going to return anything if the remote command it&rsquo;s running is sat waiting for user input.</p>
<h2 id="resolution">Resolution</h2>
<p>Armed with the above information, the solution was rather simple - gpupdate has a /boot flag which reboots the VM if required. So all that we needed to get Invoke-Command working correctly was:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Command -ComputerName $VmName -ScriptBlock {gpupdate /force /boot}
</span></span></code></pre></div><p>The take-away here is to always consider that a particular command might not behave the same way you&rsquo;ve seen it behave on other machines in the past. As a side note, if there wasn&rsquo;t a /boot switch then you could probably spoof the user input required by doing something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Command -ComputerName $VmName -ScriptBlock {echo <span style="color:#e6db74">&#34;Y&#34;</span> | gpupdate /force}
</span></span></code></pre></div>
  </div>
  <footer>
  <p>
  &copy; 2020 Matt Horgan.
  Powered by <a href="https://gohugo.io/">Hugo</a>
  using the <a href="https://github.com/koirand/pulp/">pulp</a> theme.
  </p>
</footer>


  </body>
</html>
