<!DOCTYPE html>
<html>
  <head>
  <title>
      
          Azure CLI Error Handling in PowerShell - Matt&#39;s Blog
      
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Matt Horgan" />
  <link rel="shortcut icon" type="image/x-icon" href="https://matthorgan.xyz/img/favicon.ico">

  
  
  
  
  
  <link rel="stylesheet" href="https://matthorgan.xyz/style.min.39acacc5d2051426f655a6b7fbf4786fbd0fd8fffd09322c9b497ef0f7439b3f.css" integrity="sha256-OaysxdIFFCb2Vaa3&#43;/R4b70P2P/9CTIsm0l&#43;8PdDmz8=">
  
  
  
  <link rel="stylesheet" href="https://matthorgan.xyz/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css" media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB&#43;BLd7VPoFFdCmg9OezbJR26lg/h&#43;Wb3/zb8I=">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  
  

  <meta property="og:title" content="Azure CLI Error Handling in PowerShell" />
<meta property="og:description" content="The Azure CLI (azcli) is an extremely useful tool in interacting with the Azure platform. I&rsquo;ve been favouring it over the Azure PowerShell modules recently due to many of the commands being idempotent (E.g. not having to check if something already exists before trying to create can be a nice time saver). One of the downsides to using the azcli in PowerShell scripts however, is that you can&rsquo;t handle errors like you would with a typical PowerShell cmdlet." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://matthorgan.xyz/blog/azcli-error-handling-in-powershell/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-09-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-09-16T00:00:00+00:00" />
<meta itemprop="name" content="Azure CLI Error Handling in PowerShell">
<meta itemprop="description" content="The Azure CLI (azcli) is an extremely useful tool in interacting with the Azure platform. I&rsquo;ve been favouring it over the Azure PowerShell modules recently due to many of the commands being idempotent (E.g. not having to check if something already exists before trying to create can be a nice time saver). One of the downsides to using the azcli in PowerShell scripts however, is that you can&rsquo;t handle errors like you would with a typical PowerShell cmdlet."><meta itemprop="datePublished" content="2021-09-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-09-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="652">
<meta itemprop="keywords" content="powershell,automation,azcli,ci/cd,devops," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:image" content="https://matthorgan.xyz/img/avatar.jpg"/>
<meta name="twitter:title" content="Azure CLI Error Handling in PowerShell"/>
<meta name="twitter:description" content="The Azure CLI (azcli) is an extremely useful tool in interacting with the Azure platform. I&rsquo;ve been favouring it over the Azure PowerShell modules recently due to many of the commands being idempotent (E.g. not having to check if something already exists before trying to create can be a nice time saver). One of the downsides to using the azcli in PowerShell scripts however, is that you can&rsquo;t handle errors like you would with a typical PowerShell cmdlet."/>

  <!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <![endif]-->

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112770718-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
</head>

  <body>
    
  <h1>Azure CLI Error Handling in PowerShell</h1>
  <header>
  
  <div class="avatar">
    <img class="avatarMask" src="https://matthorgan.xyz/img/avatar.jpg" alt="">
    <a href="https://matthorgan.xyz"><img class="avatar-border" src="https://matthorgan.xyz/img/avatar-border.svg" alt=""></a>
  </div>
  
  <h2><a class="author" href="https://matthorgan.xyz">Matt Horgan</a></h2>
</header>

  
  
  
  <p class="date">September 16, 2021</p>
  
  
  
  <div id="tags">
    <ul>
      
        
        
          <li><a href="https://matthorgan.xyz/tags/powershell/">powershell</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/automation/">automation</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/azcli/">azcli</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/ci/cd/">ci/cd</a></li>
        
      
        
        
          <li><a href="https://matthorgan.xyz/tags/devops/">devops</a></li>
        
      
    </ul>
  </div>
  
  
  <div id="contentBody">
    <p>The Azure CLI (azcli) is an extremely useful tool in interacting with the Azure platform. I&rsquo;ve been favouring it over the Azure PowerShell modules recently due to many of the commands being idempotent (E.g. not having to check if something already exists before trying to create can be a nice time saver). One of the downsides to using the azcli in PowerShell scripts however, is that you can&rsquo;t handle errors like you would with a typical PowerShell cmdlet.</p>
<p>Before we get into the code, it&rsquo;s worth saying that to filter data with the Azure CLI, you&rsquo;ve got two options. Option one is to use the JMESPath query parameter e.g. in the following example <code>az vm show --resource-group QueryDemo --name TestVM --query &quot;osProfile.linuxConfiguration.ssh.publicKeys&quot;</code>. The default output from the Azure CLI is JSON and so this query is targeting a nested property <code>publicKeys</code> which in JSON would look something like <code>&quot;osProfile:&quot; { &quot;linuxConfiguration&quot;: {&quot;ssh&quot;: { &quot;publicKeys&quot;: [{ &quot;someData&quot;: &quot;someDataHere&quot; }]} } }</code>. The option I prefer however, is to use PowerShell&rsquo;s <code>ConvertFrom-Json</code> cmdlet which brings us into our warm and cosy PowerShell world. So the same filter would be: <code>(az vm show --resource-group QueryDemo --name TestVM | ConvertFrom-Json).osProfile.linuxConfiguration.ssh.publicKeys</code>. I&rsquo;ll be adding the <code>ConvertFrom-Json</code> cmdlet to the examples as this is more representitive of how I&rsquo;d actually use the azcli.</p>
<p>Consider the below examples with an App Registration that doesn&rsquo;t exist:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    $appReg = Get-AzureADApplication -ObjectId <span style="color:#e6db74">&#39;NotARealObjectId&#39;</span> -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>    Write-Error <span style="color:#e6db74">&#34;Uh oh, we&#39;ve got an error here...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    $appReg = az ad app show --id <span style="color:#e6db74">&#39;NotARealObjectId&#39;</span> | ConvertFrom-Json
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>    Write-Error <span style="color:#e6db74">&#34;Uh oh, we&#39;ve got an error here...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the first example, we get a lovely handled error and a custom message but in the azcli example, nothing gets thrown because the azcli is an external tool and PowerShell doesn&rsquo;t natively know what to do with it.</p>
<p>We can improve things by making use of the <code>$LASTEXITCODE</code> which will give you the exit code of the last ran command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$appReg = az ad sp show --id <span style="color:#e6db74">&#39;NotARealObjectId&#39;</span> | ConvertFrom-Json
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($LASTEXITCODE <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    Write-Error <span style="color:#e6db74">&#34;Uh oh, we&#39;ve got an error here...&#34;</span> -ErrorAction <span style="color:#e6db74">&#39;Stop&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The above example will display our custom error message and halt the script if we get an exit code that isn&rsquo;t 0. You&rsquo;ll also find that the azcli spits out its own error but at the moment this isn&rsquo;t information that we can capture within the constraints of our own error handling - it&rsquo;ll just show the error as soon as the command isn&rsquo;t successful.</p>
<p>So how do we capture the azcli error within our own error handling? We can utilise a bit of stream redirection and a subexpression to achieve a better result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$errOutput = $($appReg = &amp; {az ad sp show --id <span style="color:#e6db74">&#39;NotARealObjectId&#39;</span> | ConvertFrom-Json}) <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($errOutput) {
</span></span><span style="display:flex;"><span>    Write-Error <span style="color:#e6db74">&#34;Uh oh, we&#39;ve got an error here...&#34;</span> -ErrorAction <span style="color:#e6db74">&#39;Continue&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> $errOutput
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this final example, we&rsquo;re executing the azcli command using the ampersand operator and capturing the variable output in the <code>$appReg</code> variable like before. However, this time we&rsquo;re using a subexpression and redirecting the error stream of that subexpression to the success stream and capturing it in a variable called <code>$errOutput</code>. Now that we&rsquo;ve got the error in a variable, we can display it and handle it however we like.</p>
<p>One thing to note is make sure you&rsquo;re aware of what output the azcli command you&rsquo;re using gives you. Some azcli commands send useful non-error commands to the error stream and therefore redirecting it like we&rsquo;ve done above will trigger an error. If you wanted to, you could technically use a hybrid of the above two methods to ensure this doesn&rsquo;t trip you up:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$errOutput = $($appReg = &amp; {az ad sp show --id <span style="color:#e6db74">&#39;NotARealObjectId&#39;</span> | ConvertFrom-Json}) <span style="color:#ae81ff">2</span>&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($LASTEXITCODE <span style="color:#f92672">-ne</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    Write-Error <span style="color:#e6db74">&#34;Uh oh, we&#39;ve got an error here...&#34;</span> -ErrorAction <span style="color:#e6db74">&#39;Continue&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> $errOutput
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  </div>
  <footer>
  <p>
  &copy; 2020 Matt Horgan.
  Powered by <a href="https://gohugo.io/">Hugo</a>
  using the <a href="https://github.com/koirand/pulp/">pulp</a> theme.
  </p>
</footer>


  </body>
</html>
